<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalMegaPro Ultimate Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --warning: #f39c12; --danger: #d93025; --dark: #202124; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; padding: 20px; background: white; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        
        /* Stat Boxes */
        .stat-box { padding: 20px; border-radius: 10px; text-align: center; border-top: 5px solid var(--primary); background: #fff; transition: 0.3s; }
        .stat-box:hover { transform: translateY(-5px); }
        .stat-box span { font-size: 0.9em; color: #666; font-weight: 600; text-transform: uppercase; }
        .stat-box b { font-size: 1.4em; display: block; margin-top: 10px; }

        /* Matrix Tree */
        .matrix-container { display: flex; flex-direction: column; align-items: center; background: #f9f9f9; padding: 20px; border-radius: 10px; }
        .node-main { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 30px; position: relative; }
        .node-main::after { content: ''; position: absolute; bottom: -30px; width: 2px; height: 30px; background: #ccc; }
        .slots { display: flex; gap: 20px; }
        .slot-card { text-align: center; width: 100px; }
        .slot-circle { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #ddd; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #fff; }
        .slot-circle.filled { background: var(--success); color: white; border-color: #1e7e34; box-shadow: 0 0 10px rgba(40,167,69,0.4); }
        .addr-small { font-size: 10px; color: #777; word-break: break-all; }

        /* Team List */
        .list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .list-table th, .list-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        .list-table th { background: #f8f9fa; }

        input, select { padding: 12px; margin: 10px 0; width: 100%; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .bg-success { background: #e8f5e9; color: var(--success); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>GlobalMegaPro Ultimate</h1>
        <button id="connectBtn" style="width: auto;">Connect Wallet</button>
        <p id="userWallet" style="margin-top:10px; color: var(--primary); font-weight: bold;"></p>
    </div>

    <div class="grid-4">
        <div class="stat-box"><span>User ID</span> <b id="st_id">0</b></div>
        <div class="stat-box" style="border-top-color: var(--success);"><span>Withdrawable</span> <b id="st_bal">0.00</b></div>
        <div class="stat-box"><span>Total Earned</span> <b id="st_earned">0.00</b></div>
        <div class="stat-box" style="border-top-color: var(--danger);"><span>Income Cap</span> <b id="st_cap">0.00</b></div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Detailed Income Report</h3>
        <div class="grid-4">
            <div class="stat-box"><span>Direct</span> <b id="in_direct">0</b></div>
            <div class="stat-box"><span>Level</span> <b id="in_level">0</b></div>
            <div class="stat-box"><span>Single Leg</span> <b id="in_single">0</b></div>
            <div class="stat-box"><span>Matrix Pool</span> <b id="in_matrix">0</b></div>
            <div class="stat-box"><span>Daily Pool</span> <b id="in_daily">0</b></div>
            <div class="stat-box"><span>Rewards</span> <b id="in_reward">0</b></div>
            <div class="stat-box" style="border-top-color: var(--danger);"><span>Capping Loss</span> <b id="in_loss">0</b></div>
            <div class="stat-box" style="border-top-color: var(--warning);"><span>Directs</span> <b id="st_directs">0</b></div>
        </div>
    </div>

    <div class="grid-4" style="grid-template-columns: 2fr 1fr;">
        <div class="card">
            <h3>Matrix Visualizer (3x1)</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <select id="mtxPkg">
                    <option value="0">Package 0 ($5)</option>
                    <option value="1">Package 1 ($44)</option>
                    <option value="3">Package 3 ($106)</option>
                </select>
                <input type="number" id="mtxIdx" placeholder="Enter Queue Index (e.g. 0, 1, 2)">
                <button onclick="renderMatrix()" style="width: 200px;">View Tree</button>
            </div>
            
            <div id="matrixDisplay" class="matrix-container" style="display: none;">
                <div class="node-main" id="mtxOwner">P</div>
                <div class="slots">
                    <div class="slot-card"><div id="sA" class="slot-circle">A</div><div id="adrA" class="addr-small">-</div></div>
                    <div class="slot-card"><div id="sB" class="slot-circle">B</div><div id="adrB" class="addr-small">-</div></div>
                    <div class="slot-card"><div id="sC" class="slot-circle">C</div><div id="adrC" class="addr-small">-</div></div>
                </div>
                <p id="mtxStatus" style="margin-top: 20px; font-weight: bold;"></p>
            </div>
        </div>

        <div class="card">
            <h3>My Level Team</h3>
            <button class="btn-outline" onclick="loadTeam()">Refresh Team List</button>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="list-table">
                    <thead><tr><th>Address</th></tr></thead>
                    <tbody id="teamBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Join & Upgrade</h3>
        <div class="grid-4" style="grid-template-columns: 1fr 1fr;">
            <div>
                <label>New Registration</label>
                <input type="text" id="refAddr" placeholder="Referrer Wallet Address">
                <button onclick="handleRegister()">Register Now</button>
            </div>
            <div>
                <label>Buy/Upgrade Package</label>
                <input type="number" id="buyPkgId" placeholder="Package ID (0-11)">
                <button class="btn-outline" onclick="handleApprove()">1. Approve USDT</button>
                <button onclick="handleBuy()" style="background: var(--success);">2. Confirm Purchase</button>
            </div>
        </div>
        <button onclick="handleWithdraw()" style="background: var(--dark); margin-top: 20px;">Withdraw All Funds (10% Fee)</button>
    </div>
</div>

<script>
    const CONTRACT_ADDR = "0x9c87C960e27649B903233F1Bd8351E513fD17B70";
    const USDT_ADDR = "0x3B66b1E08F55AF26c8eA14a73dA64b6bC8D799dE";
    
    // Updated ABI for your new Smart Contract
    const ABI = [
        "function register(address ref) external",
        "function buyPackage(uint256 id) external",
        "function withdraw() external",
        "function getUserTotalData(address user) view returns (uint256[6] stats, uint256[6] incomes, address ref)",
        "function getMatrixTree(uint256 pkg, uint256 idx) view returns (address ownerAddr, uint256 filledCount, uint256 ownerRebirths, address slotA, address slotB, address slotC)",
        "function getLevelTeam(address user) view returns (address[])",
        "function packages(uint256 id) view returns (uint256 price)"
    ];

    let signer, contract, usdt;

    document.getElementById('connectBtn').onclick = async () => {
        if (window.ethereum) {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            document.getElementById('userWallet').innerText = "Active: " + addr;
            
            contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
            usdt = new ethers.Contract(USDT_ADDR, ["function approve(address s, uint256 a) public returns (bool)"], signer);
            
            loadAllData();
        }
    };

    async function loadAllData() {
        const addr = await signer.getAddress();
        const d = await contract.getUserTotalData(addr);
        
        // Stats mapping from stats[6] array
        document.getElementById('st_id').innerText = d.stats[0];
        document.getElementById('st_bal').innerText = ethers.utils.formatEther(d.stats[1]);
        document.getElementById('st_earned').innerText = ethers.utils.formatEther(d.stats[2]);
        document.getElementById('st_cap').innerText = ethers.utils.formatEther(d.stats[3]);
        document.getElementById('st_directs').innerText = d.stats[4];
        document.getElementById('in_loss').innerText = ethers.utils.formatEther(d.stats[5]);

        // Incomes mapping from incomes[6] array
        document.getElementById('in_direct').innerText = ethers.utils.formatEther(d.incomes[0]);
        document.getElementById('in_level').innerText = ethers.utils.formatEther(d.incomes[1]);
        document.getElementById('in_single').innerText = ethers.utils.formatEther(d.incomes[2]);
        document.getElementById('in_matrix').innerText = ethers.utils.formatEther(d.incomes[3]);
        document.getElementById('in_daily').innerText = ethers.utils.formatEther(d.incomes[4]);
        document.getElementById('in_reward').innerText = ethers.utils.formatEther(d.incomes[5]);
    }

    async function renderMatrix() {
        const pkg = document.getElementById('mtxPkg').value;
        const idx = document.getElementById('mtxIdx').value;
        try {
            const res = await contract.getMatrixTree(pkg, idx);
            document.getElementById('matrixDisplay').style.display = "flex";
            document.getElementById('mtxStatus').innerText = `Filled: ${res.filledCount}/3 | Rebirths: ${res.ownerRebirths}`;
            
            updateSlot('sA', 'adrA', res.slotA, res.filledCount >= 1);
            updateSlot('sB', 'adrB', res.slotB, res.filledCount >= 2);
            updateSlot('sC', 'adrC', res.slotC, res.filledCount >= 3);
        } catch (e) { alert("Matrix Data not found for this Index"); }
    }

    function updateSlot(sid, aid, addr, isFilled) {
        const s = document.getElementById(sid);
        const a = document.getElementById(aid);
        if(isFilled && addr !== "0x0000000000000000000000000000000000000000") {
            s.classList.add('filled');
            a.innerText = addr.substring(0,6) + "...";
        } else {
            s.classList.remove('filled');
            a.innerText = "Empty";
        }
    }

    async function loadTeam() {
        const addr = await signer.getAddress();
        const team = await contract.getLevelTeam(addr);
        const body = document.getElementById('teamBody');
        body.innerHTML = team.map(m => `<tr><td>${m} <span class="badge bg-success">Direct</span></td></tr>`).join('');
    }

    // Logic Functions
    async function handleApprove() {
        const id = document.getElementById('buyPkgId').value;
        const price = await contract.packages(id);
        const tx = await usdt.approve(CONTRACT_ADDR, price);
        await tx.wait();
        alert("USDT Approved!");
    }

    async function handleBuy() {
        const id = document.getElementById('buyPkgId').value;
        const tx = await contract.buyPackage(id);
        await tx.wait();
        loadAllData();
        alert("Package Activated!");
    }

    async function handleRegister() {
        const ref = document.getElementById('refAddr').value || "0x0000000000000000000000000000000000000000";
        const tx = await contract.register(ref);
        await tx.wait();
        alert("Registration Successful!");
    }

    async function handleWithdraw() {
        const tx = await contract.withdraw();
        await tx.wait();
        loadAllData();
    }
</script>

</body>
</html>
